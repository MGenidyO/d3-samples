<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>ProjeCS Demo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dxf-parser@1.1.2/dist/dxf-parser.min.js"></script>
  <style>
    #tooltip {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <div class="container-fluid">
      <img class="navbar-brand" src="./images/projecs22.png" height="40" width="170" />
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-4 mt-3">
          <li class="nav-item"><a class="nav-link" href="#">Project 01</a></li>
          <li class="nav-item"><a class="nav-link" href="#"> > </a></li>
          <li class="nav-item"><a class="nav-link active" id="House" href="#">Airport</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container-fluid">
    <div class="row">
      <nav class="col-md-4 col-lg-2 d-md-block sidebar">
        <div class="d-flex align-items-center">
          <img src="./images/back.png" id="backImg" class="ms-3 mt-2">
          <h5 class="mt-3">Layers</h5>
        </div>
        <ul class="nav flex-column">
          <li class="nav-item mt-3">
            <button class="btn btn-primary d-flex align-items-center" type="button" data-bs-toggle="collapse"
              data-bs-target="#myCollapse" aria-expanded="false" aria-controls="myCollapse">
              Add Layers
              <span class="ms-2">	&#43;</span>
            </button>
            <div class="collapse mt-2" id="myCollapse">
              <div class="mb-3">
                <label for="layerName" class="form-label">Layer name</label>
                <input type="text" class="form-control" id="layerName" placeholder="Please enter layer name">
              </div>
              <div class="mb-3">
                <label for="upload-dxf-input" class="form-label">Dxf file</label>
                <input type="file" class="form-control" id="upload-dxf-input" accept=".dxf">
              </div>
              <div class="mb-3">
                <label for="upload-file-input" class="form-label">Progress excel file</label>
                <input type="file" class="form-control" id="upload-file-input"
                  accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
              </div>
              <div class="mb-3">
                <label for="layerScale" class="form-label">Layer Scale</label>
                <input type="number" class="form-control" id="layerScale" placeholder="Enter scale (default is 1)" step="0.1" value="1">
              </div>  
              <div class="mb-3">
                <input type="button" class="btn btn-success" id="saveButton" value="Save">
              </div>       
            </div>
            <div id="layer-controls" class="mt-3">
            <h6>Manage Layers</h6>
            <ul id="layerList"></ul>
          </div>
          </li>
        </ul>
      </nav>
      <!-- Main Content -->
      <main class="col-md-7 col-lg-9  mt-4 px-md-4">
        <div class="w-75 mx-auto">
          <div class="d-flex justify-content-between mb-1 text-center">
            <div class="text-start">
              <span id="completed-progress-title-value" class="d-block fw-bold fs-1">40%</span>
              <span class="fs-1">Completed</span>
            </div>
            <div>
              <span id="pending-progress-title-value" class="d-block fw-bold fs-1">60%</span>
              <span class="fs-1">Pending</span>
            </div>
          </div>
          <div class="progress">
            <div id="completed-progress-bar-value" class="progress-bar bg-warning" role="progressbar"
              style="width: 40%;" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
            <div id="pending-progress-bar-value" class="progress-bar bg-secondary" role="progressbar"
              style="width: 60%;" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="mt-2">
            <span class="fs-3">Current phase: Structural frame</span>
          </div>
        </div>
        <div class="d-flex justify-content-center mb-3">
          <div class="row">
            <div class="col-md-12">
              <div id="svg_client_2_container">
                <svg width="1000" height="800" style="border:1px solid black;"></svg>
              </div>
              <div id="tooltip">
              </div>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
              integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
              crossorigin="anonymous"></script>
            <script src="./lib/import_js_files.js" type="module"></script>
          </div>
        </div>
        <div class="d-flex justify-content-start gap-4 my-1 ms-5 text-center">
          <div class="d-flex flex-column align-items-center">
            <div class="color1"></div>
            <div class="mt-2">0–29%</div>
          </div>
          <div class="d-flex flex-column align-items-center">
            <div class="color2"></div>
            <div class="mt-2">30–70%</div>
          </div>
          <div class="d-flex flex-column align-items-center">
            <div class="color3"></div>
            <div class="mt-2">71+%</div>
          </div>
        </div>
      </main>
    </div>
  </div>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dxf-parser@1.1.5/dist/dxf-parser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <script type="module">
const layerList = document.getElementById('layerList');
const saveButton = document.getElementById('saveButton');
const layerInput = document.getElementById('layerName');
const excelFile = document.getElementById("upload-file-input");
const dxfFile = document.getElementById("upload-dxf-input");
const scaleInput = document.getElementById("layerScale");
saveButton.addEventListener('click', () => {
  const layerName = layerInput.value.trim();

  if (layerName === '' || excelFile === '' || dxfFile === '' || scaleInput === '' ) {
    alert('Please enter the valid data');
    return;
  }

  // Create list item
  const li = document.createElement('li');
  li.classList.add('d-flex', 'align-items-center', 'mb-2');

  // Create checkbox
  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.classList.add('form-check-input', 'me-2');
  checkbox.checked = true;

  // Create layer name text
  const span = document.createElement('span');
  span.textContent = layerName;
  span.classList.add('me-auto');

  // Create trash icon
  const trash = document.createElement('i');
  trash.classList.add('bi', 'bi-trash', 'text-danger', 'ms-2');
  trash.style.cursor = 'pointer';

  // Trash click removes the layer
  trash.addEventListener('click', () => {
      d3.select("svg").selectAll("#uploaded-dxf-group").remove();  // Remove old DXF group
    li.remove();
  });
 checkbox.addEventListener('change', (e) => {
  const isChecked = e.target.checked;
    const layerGroup =  d3.select("svg").selectAll("#uploaded-dxf-group");
  layerGroup.style('display', isChecked ? null : 'none');
});
  
  // Append all elements
  li.appendChild(checkbox);
  li.appendChild(span);
  li.appendChild(trash);
  layerList.appendChild(li);

  // Clear input
  layerInput.value = '';
  excelFile.value='';
  dxfFile.value='';
  scaleInput.value='';
});


    document.getElementById('layerScale').addEventListener('input', function() {
        const scaleValue = parseFloat(this.value) || 1; // Default to 1 if invalid
        console.log('Scale Value:', scaleValue); 
        if (window.lastDxfData) {
            drawUploadedDXF(window.lastDxfData, scaleValue); 
        }
    });
    let excelData = []; // Will hold Excel rows
    let uploadGroup;
    document.getElementById('upload-file-input').addEventListener('change', handleExcelUpload);

    // Function to handle uploaded Excel file
    function handleExcelUpload(event) {
      const file = event.target.files[0];
      if (!file) return console.log("No Excel selected");
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        excelData = XLSX.utils.sheet_to_json(sheet);
        console.log("Excel Parsed Data:", excelData);
        const svg = d3.select("svg"); 
        const existingDxfGroup = svg.select("#uploaded-dxf-group");
        if (!existingDxfGroup.empty()) {
          drawUploadedDXF(window.lastDxfData); 
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Function to generate tooltip content by mapping all Excel rows
    function getTooltipContent(entity) {
      // Map over ALL rows and format each row
      let info = excelData.map((row, index) => {
        let rowInfo = Object.entries(row).map(([key, value]) => {
          return `${key}: ${value}`;
        }).join("<br>");
        return `<b>Row ${index + 1}:</b><br>${rowInfo}`;
      }).join("<br><br>"); // separate rows

      return info;
    }

    const svgWidth = 1000;
    const svgHeight = 1000;
    document.getElementById('upload-dxf-input').addEventListener('change', handleDxfUpload);

    // Function to calculate the bounds (min/max X and Y) of DXF entities
    function getBounds(entities) {
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      entities.forEach(entity => {
        if (entity.vertices) {
          entity.vertices.forEach(vertex => {
            minX = Math.min(minX, vertex.x);
            minY = Math.min(minY, vertex.y);
            maxX = Math.max(maxX, vertex.x);
            maxY = Math.max(maxY, vertex.y);
          });
        } else if (entity.center) {
          minX = Math.min(minX, entity.center.x - entity.radius);
          minY = Math.min(minY, entity.center.y - entity.radius);
          maxX = Math.max(maxX, entity.center.x + entity.radius);
          maxY = Math.max(maxY, entity.center.y + entity.radius);
        }
      });
      return { minX, minY, maxX, maxY };
    }


    // Function to handle DXF file upload
    async function handleDxfUpload(event) {
      const file = event.target.files[0];
      if (!file) return console.log("No file selected");
      const reader = new FileReader();
      reader.onload = function (e) {
        const parser = new DxfParser();
        let dxfData;
        try {
          dxfData = parser.parseSync(e.target.result);
          window.lastDxfData = dxfData; // Store dxfData globally
          const scaleInput = parseFloat(document.getElementById("layerScale").value) || 1;
          drawUploadedDXF(dxfData, scaleInput);

        } catch (error) {
          console.error("Error parsing DXF:", error);
          return;
        }
        console.log("DXF Parsed Data:", dxfData);
        // drawUploadedDXF(dxfData);
      };
      reader.readAsText(file);
    }


    // Function to draw uploaded DXF entities on SVG
    function drawUploadedDXF(dxfData, userScale = 1) {
      const svg = d3.select("svg");
      svg.selectAll("#uploaded-dxf-group").remove();  // Remove old DXF group
      const uploadGroup = svg.append("g")
        .attr("id", "uploaded-dxf-group")
        .attr("transform", "translate(0,0)")
        .style("cursor", "move");
      let currentX = 0, currentY = 0;
      // Make the group draggable
      uploadGroup.call(
        d3.drag()
          .on("drag", function (event) {
            currentX += event.dx;
            currentY += event.dy;
            d3.select(this).attr("transform", `translate(${currentX},${currentY})`);
          })
      );

      const bounds = getBounds(dxfData.entities);
      if (bounds.maxX === bounds.minX || bounds.maxY === bounds.minY) {
        console.error("Invalid bounds – DXF data may be empty or invalid");
        return;
      }

      const tooltip = d3.select("#tooltip");
      const baseScale = 700 / (bounds.maxX - bounds.minX);
      const scale = baseScale * userScale;  
      const offsetX = -bounds.minX * scale + (svgWidth - (bounds.maxX - bounds.minX) * scale) / 2;
      const offsetY = -bounds.minY * scale + (svgHeight - (bounds.maxY - bounds.minY) * scale) / 2;

      dxfData.entities.forEach(entity => {
        switch (entity.type) {
          case "LINE":
            uploadGroup.append("line")
              .attr("x1", entity.vertices[0].x * scale + offsetX)
              .attr("y1", svgHeight - (entity.vertices[0].y * scale + offsetY))
              .attr("x2", entity.vertices[1].x * scale + offsetX)
              .attr("y2", svgHeight - (entity.vertices[1].y * scale + offsetY))
              .attr("stroke", "black")
              .attr("stroke-width", 2)
              .on("mouseover", function (event) {
                d3.select("#tooltip")
                  .style("display", "block")
                  .style("opacity", 1)
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY + 10) + "px")
                  .html(getTooltipContent(entity) + "<br>Tooltip working");
              })
              .on("mousemove", function (event) {
                d3.select("#tooltip")
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY + 10) + "px");
              })
              .on("mouseout", function (d) {
                tooltip.transition()
                  .duration(500)
                  .style("display", "none")
                  .style("opacity", 0);
              });
            break;

          case "CIRCLE":
            uploadGroup.append("circle")
              .attr("cx", entity.center.x * scale + offsetX)
              .attr("cy", svgHeight - (entity.center.y * scale + offsetY))
              .attr("r", entity.radius * scale)
              .attr("stroke", "black")
              .attr("fill", "none")
              .attr("stroke-width", 2)
              .on("mouseover", function (event) {
                d3.select("#tooltip")
                  .style("display", "block")
                  .style("opacity", 1)
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY + 10) + "px")
                  .html(getTooltipContent(entity) + "<br>Tooltip working");
              })
              .on("mousemove", function (event) {
                d3.select("#tooltip")
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY + 10) + "px");
              })
              .on("mouseout", function (d) {
                tooltip.transition()
                  .duration(500)
                  .style("display", "none")
                  .style("opacity", 0);
              });
            break;

          case "POLYLINE":
          case "LWPOLYLINE":
            const points = entity.vertices.map(v => [
              v.x * scale + offsetX,
              svgHeight - (v.y * scale + offsetY)
            ]);
            // const points = entity.vertices.map(v => [
            //   v.x * 30,
            //   (v.y * 30)
            // ]);
            uploadGroup.append("polyline")
              .attr("points", points.join(" "))
              .attr("stroke", "black")
              .attr("fill", "none")
              .attr("stroke-width", 2)
              .on("mouseover", function (event) {
                d3.select("#tooltip")
                  .style("display", "block")
                  .style("opacity", 1)
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY + 10) + "px")
                  .html(getTooltipContent(entity) + "<br>Tooltip working");
              })
              .on("mousemove", function (event) {
                d3.select("#tooltip")
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY + 10) + "px");
              })
              .on("mouseout", function (d) {
                tooltip.transition()
                  .duration(500)
                  .style("display", "none")
                  .style("opacity", 0);
              });
            break;

          case "POINT":
            uploadGroup.append("circle")
              .attr("cx", entity.position.x * scale + offsetX)
              .attr("cy", svgHeight - (entity.position.y * scale + offsetY))
              .attr("r", 3)
              .attr("fill", "red")
              .on("mouseover", function (event) {
                d3.select("#tooltip")
                  .style("display", "block")
                  .style("opacity", 1)
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY + 10) + "px")
                  .html(getTooltipContent(entity) + "<br>Tooltip working");
              })
              .on("mousemove", function (event) {
                d3.select("#tooltip")
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY + 10) + "px");
              })
              .on("mouseout", function (d) {
                tooltip.transition()
                  .duration(500)
                  .style("display", "none")
                  .style("opacity", 0);
              });
            break;

          case "MTEXT":
            uploadGroup.append("text")
              .attr("x", entity.position.x * scale + offsetX)
              .attr("y", svgHeight - (entity.position.y * scale + offsetY))
              .attr("font-size", 12)
              .attr("fill", "blue")
              .text(entity.text || "")
              .on("mouseover", function (event) {
                d3.select("#tooltip")
                  .style("display", "block")
                  .style("opacity", 1)
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY + 10) + "px")
                  .html(getTooltipContent(entity) + "<br>Tooltip working");
              })
              .on("mousemove", function (event) {
                d3.select("#tooltip")
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY + 10) + "px");
              })
              .on("mouseout", function (d) {
                tooltip.transition()
                  .duration(500)
                  .style("display", "none")
                  .style("opacity", 0);
              });
            break;

          default:
            console.log("Unsupported uploaded entity type:", entity.type);
        }
      });
    }

    // Initialize drag behavior
    const drag = d3.drag()
      .on("start", dragStarted)
      .on("drag", dragged)
      .on("end", dragEnded);

    uploadGroup.call(drag);
    let currentTransform = d3.zoomIdentity;

    function dragStarted(event) {
      d3.select(this).raise().attr("stroke", "black");
    }

    function dragged(event) {
      currentTransform = currentTransform.translate(event.dx, event.dy);
      d3.select(this).attr("transform", currentTransform);
    }

    function dragEnded(event) {
      d3.select(this).attr("stroke", null);
    }
  </script>
</body>
</html>