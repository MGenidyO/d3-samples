<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>ProjeCS Demo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="./styles.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dxf-parser@1.1.2/dist/dxf-parser.min.js"></script>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Contech</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-4">
          <li class="nav-item"><a class="nav-link" href="#">Project 01</a></li>
          <li class="nav-item"><a class="nav-link" href="#"> > </a></li>
          <li class="nav-item"><a class="nav-link active" id="House" href="#">House 01</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Left Sidebar  -->
      <nav class="col-md-4 col-lg-2 d-md-block sidebar ms-2">
        <div class="d-flex align-items-center">
          <img src="./images/back.png" id="backImg" class="ms-3 mt-2">
          <h5 class="mt-3">Layers</h5>
        </div>
        <ul class="nav flex-column">

          <!-- <li class="nav-item"><a href="#" class="nav-link"><img class="icon" src="./images/pipe.png">Pipes</a></li>
          <li class="nav-item"><a href="#" class="nav-link"><img class="icon"
                src="./images/underground_caples.png">Underground Cables</a>
          </li>
          <li class="nav-item"><a href="#" class="nav-link"><img class="icon" src="./images/doors_windows.png">Doors
              &Windows</a></li>
          <li class="nav-item"><a href="#" class="nav-link"><img class="icon"
                src="./images/power_grid.png">PowerGrid</a></li>
          <li class="nav-item"><a href="#" class="nav-link"><img class="icon" src="./images/safety.png">Safety</a></li>
          <li class="nav-item"><a href="#" class="nav-link"><img class="icon" src="./images/painted.png">Painted</a>
          </li>
          <li class="nav-item"><a href="#" class="nav-link"><img class="icon"
                src="./images/mechanical_equipments.png">Mechanical Equipment</a></li> -->
          <li class=" nav-item mt-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="flexSwitchCheckChecked">
              <label class="form-check-label" for="flexSwitchCheckChecked">Display Progress</label>
            </div>
          </li>
          <li class="nav-item my-1">
            <input type="checkbox" name="chbx-level" id="layer1" checked> JFK-HH-LV1-arc-zones-1
          </li>
          <li class="nav-item my-1">
            <input type="checkbox" name="chbx-level" id="layer2" checked> JFK-HH-LV2-arc-zones
          </li>
          <li class="nav-item my-1">
            <input type="checkbox" name="chbx-level" id="layer3" checked> JFK-HH-LV3-arc-zones
          </li>
        </ul>
      </nav>

      <!-- Main Content -->
      <main class="col-md-8 col-lg-10  mt-4 px-md-4">
        <!-- <h2 class="text-center mt-3">Project 01</h2> -->
        <!-- <div class="d-flex justify-content-center mb-3">
          <ul class="nav nav-pills">
            <li class="nav-item"><a class="nav-link active" href="#">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="./ProjeCS/ProjeCS.html">ProjeCS 1</a></li>
            <li class="nav-item"><a class="nav-link" href="./ModifiedFloor/AdjustedFloor.html">Floor 2</a></li>
            <li class="nav-item"><a class="nav-link" href="./UsMap/UsMap.html">UsMAp 3</a></li>
            <li class="nav-item"><a class="nav-link" href="./ProgressMap/tutorial/13/index.html">Progress 4</a></li>
            <li class="nav-item"><a class="nav-link" href="./Building/Building.html">Building 5</a></li>
            <li class="nav-item"><a class="nav-link" href="./Building/BuildingFloor/Floor.html">Floor 6</a></li>
          </ul>
        </div> -->

        <div class="d-flex justify-content-center mb-3">
          <div class="row">
            <div class="col-md-12">
              <div id="svg_client_2_container"></div>
              <div id="tooltip">
              </div>
            </div>
            <div class="col-md-12">
              <!-- <div id="svg_us_container"></div> -->
            </div>
            <div class="col-md-12">
              <!-- <div id="svg_container"></div> -->
            </div>
            <div id="controls">
              <label for="scale-layer1">Scale Layer 1:</label>
              <input type="range" id="scale-layer1" min="0.5" max="2" step="0.1" value="1">
              
              <label for="scale-layer2">Scale Layer 2:</label>
              <input type="range" id="scale-layer2" min="0.5" max="2" step="0.1" value="1">
            
              <label for="scale-layer3">Scale Layer 3:</label>
              <input type="range" id="scale-layer3" min="0.5" max="2" step="0.1" value="1">
            </div>
            
          
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
              integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
              crossorigin="anonymous"></script>

            <script src="./lib/import_js_files.js" type="module"></script>
            <!-- <script src="../ModifiedFloor/AdjustedFloor.js" type="module"></script>
            <script src="../UsMap/UsMap.js" type="module"></script> -->
            <script src="./ProjeCS/ProjeCS.js" type="module"></script>
          </div>
        </div>
      </main>

      <!-- Right Sidebar -->
      <!-- <aside class="col-md-3 col-lg-2 d-md-block house-details mt-4">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="mb-0" id="HouseDetails">House Details</h5>
          <img src="./images/info.png" width="30px" height="30px" class="ms-2 mb-0">
        </div>
        <ul class="list-unstyled">
          <li>House Name: House 01</li>
          <li>House ID: H-01</li>
          <li>Status: Occupied</li>
          <li>Total Area: 250 m²</li>
          <li>Rooms: 2</li>
          <li>Construction Year: 2018</li>
        </ul>
        <h5 class="mt-3">Paint & Finishing</h5>
        <ul class="list-unstyled">
          <li>Exterior: Light Beige</li>
          <li>Interior: Soft Gray</li>
          <li>Kitchen: Sky Blue</li>
          <li>Living Room: White Gloss</li>
          <li>Next Repaint: 2026</li>
        </ul>
        <h5 class="mt-3">Pipes & Plumbing</h5>
        <ul class="list-unstyled">
          <li>Water: Active</li>
          <li>Sewage: City Drainage</li>
          <li>Kitchen: Water Pipe Leak</li>
          <li>Bathroom: Drain Blockage</li>
        </ul>
      </aside> -->
    </div>
  </div>
  <!-- <footer class="footer text-center">
    <p>© 2025 SmartMap Interactive. All Rights Reserved.</p>
  </footer> -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    const layers = { 1: null, 2: null, 3: null };
    const layerColors = { 1: "blue", 2: "red", 3: "pink" };

    const client_levels_data = await d3.json(`./data/ProjecsLevelsData.json`);
    const completeList = [0,100];
    const colorLevelScale = d3.scaleSequential(d3.interpolateGreens)
      //.domain(completeList)
      //.range(d3.schemeCategory10);
    // async function loadDXF(file, layer) {
    //     const text = await file.text();
    //     const parser = new DxfParser();
    //     try {
    //         const dxfData = parser.parseSync(text);
    //         layers[layer] = dxfData;
    //         console.log(`Loaded DXF for Layer ${layer}`, dxfData);
    //         renderLayers();
    //     } catch (error) {
    //         console.error(`Error parsing DXF for Layer ${layer}:`, error);
    //     }
    // }

    //Old function without scaling 
    //function renderLayers() {
      //const svg = d3.select("svg");
      //svg.selectAll(".new-level").remove();

      // svg.append("rect")
      //     .attr("x", 0)
      //     .attr("y", 0)
      //     .attr("width", 800)
      //     .attr("height", 600)
      //     .attr("stroke", "black")
      //     .attr("fill", "none");

   //   Object.entries(layers).forEach(([layer, data]) => {
   //     if (data && document.getElementById(`layer${layer}`).checked) {
   //       const layerGroup = svg.append("g")
   //         .attr("id", `layer-group-${layer}`)
   //         .attr("transform", "translate(0, 0)")
   //         .style("cursor", "grab")
   //         .attr("class", "new-level")
   //         .call(d3.drag()
   //           .on("start", dragStarted)
   //           .on("drag", dragged)
   //           .on("end", dragEnded)
   //         );

   //       drawDXF(data, layerGroup, layer);
   //     }
   //   });
   // }

const layerScales = { 1: 1, 2: 1, 3: 1 }; 
const layerTransforms = { 1: { x: 0, y: 0 }, 2: { x: 0, y: 0 }, 3: { x: 0, y: 0 } }; 

function renderLayers() {
  const svg = d3.select("svg");
  svg.selectAll(".new-level").remove();

  Object.entries(layers).forEach(([layer, data]) => {
    if (data && document.getElementById(`layer${layer}`).checked) {
      const layerGroup = svg.append("g")
        .attr("id", `layer-group-${layer}`)
        .attr("transform", "translate(0, 0)")
        .style("cursor", "grab")
        .attr("class", "new-level")
        .call(d3.drag()
              .on("start", dragStarted)
              .on("drag", dragged)
              .on("end", dragEnded)
        );

      drawDXF(data, layerGroup, layer);

      d3.select(`#scale-layer${layer}`).on("input", function () {
        layerScales[layer] = this.value;
         updateTransform(layer);
      });
    }
  });
}

  function updateTransform(layer) {
  console.log(`Updating transform for layer ${layer}:`, layerTransforms[layer]);
  const { x, y } = layerTransforms[layer];
  const scale = layerScales[layer];

  d3.select(`#layer-group-${layer}`)
    .attr("transform", `translate(${x}, ${y}) scale(${scale})`);
}

    const tooltip2 = d3.select("#tooltip")
      .style("opacity", 0)
      .attr("class", "tooltip");

    function drawDXF(dxfData, layerGroup, layer) {
      const color = layerColors[layer] || "black";
      const multiLayerSelected = document.querySelectorAll('input[name=chbx-level]:checked').length > 1;
      const progressChecked = document.getElementById(`flexSwitchCheckChecked`).checked;

      const bounds = getBounds(dxfData.entities);
      if (bounds.maxX === bounds.minX || bounds.maxY === bounds.minY) {
        console.error("Invalid bounds – DXF data may be empty or invalid");
        return;
      }

      const scaleX = 1580 / (bounds.maxX - bounds.minX);
      const scaleY = 1300 / (bounds.maxY - bounds.minY);
      const scale = Math.min(scaleX, scaleY) * 0.9;
      const offsetX = -bounds.minX * scale + (800 - (bounds.maxX - bounds.minX) * scale) / 2;
      const offsetY = -bounds.minY * scale + (600 - (bounds.maxY - bounds.minY) * scale) / 2;

      dxfData.entities.forEach(entity => {
        console.info((Math.floor(client_levels_data.find((e) => e.UniqueID == entity.layer && e.Level == layer)?.complete*100)));
        console.info(colorLevelScale(Math.floor(client_levels_data.find((e) => e.UniqueID == entity.layer && e.Level == layer)?.complete*100)));
        switch (entity.type) {
          case "LINE":
            layerGroup.append("line")
              .attr("x1", entity.vertices[0].x * scale + offsetX)
              .attr("y1", 780 - (entity.vertices[0].y * scale + offsetY))
              .attr("x2", entity.vertices[1].x * scale + offsetX)
              .attr("y2", 780 - (entity.vertices[1].y * scale + offsetY))
              .attr("stroke", color)
              .attr("stroke-width", 2);
            break;

          case "CIRCLE":
            layerGroup.append("circle")
              .attr("cx", entity.center.x * scale + offsetX)
              .attr("cy", 780 - (entity.center.y * scale + offsetY))
              .attr("r", entity.radius * scale)
              .attr("stroke", color)
              .attr("fill", multiLayerSelected ? "none" : progressChecked ? colorLevelScale(((client_levels_data.find((e) => e.UniqueID == entity.layer && e.Level == layer)?.complete))) : "white")
              //.attr("fill", multiLayerSelected ? "none" : "white")
              .style("fill-opacity", multiLayerSelected ? 1 : progressChecked ? 1 : 0.35)
              .attr("stroke-width", 2)
              .on("mouseover", function (d) {

                tooltip2.style("opacity", 0.9);
                tooltip2
                  .html(() => {

                    return `<p></p><p><b>Complete:</b> ${Math.floor((client_levels_data.find((e) => e.UniqueID == entity.layer && e.Level == layer)?.complete) * 100)} %</p>
  <p><b>Finish:</b> ${client_levels_data.find((e) => e.UniqueID == entity.layer && e.Level == layer)?.Finish}</p>
  <p><b>Description:</b> ${client_levels_data.find((e) => e.UniqueID == entity.layer && e.Level == layer)?.Description}</p>
  <p><b>Level:</b>  ${client_levels_data.find((e) => e.UniqueID == entity.layer)?.Level && e.Level == layer}</p><p></p>`;

                  })
                tooltip2.append("img")
                  .attr("src", "./images/projecs.png")

                tooltip2
                  .style("left", d.pageX + 10 + "px")
                  .style("top", d.pageY - 28 + "px");
              })
              .on("mouseout", d => {
                tooltip2.style("opacity", 0);
              });
            break;

          case "POLYLINE":
          case "LWPOLYLINE":
            const points = entity.vertices.map(v => [
              v.x * scale +( offsetX +312 ),
              785 - (v.y * scale + offsetY)
            ]);

            layerGroup.append("polyline")
              .attr("points", points.join(" "))
              .attr("stroke", color)
              .attr("fill", multiLayerSelected ? "none" : progressChecked ? colorLevelScale(((client_levels_data.find((e) => e.UniqueID == entity.layer && e.Level == layer)?.complete))) : "white")
              //.attr("fill", multiLayerSelected ? "none" : "white")
              .style("fill-opacity", multiLayerSelected ? 1 : progressChecked ? 1 : 0.3)
              .attr("stroke-width", 2)
              .on("mouseover", function (d) {

                tooltip2.style("opacity", 0.9);
                tooltip2
                  .html(() => {

                    return `<p></p><p><b>Complete:</b> ${Math.floor((client_levels_data.find((e) => e.UniqueID == entity.layer && e.Level == layer)?.complete) * 100)} %</p>
  <p><b>Finish:</b> ${client_levels_data.find((e) => e.UniqueID == entity.layer && e.Level == layer)?.Finish}</p>
  <p><b>Description:</b> ${client_levels_data.find((e) => e.UniqueID == entity.layer && e.Level == layer)?.Description}</p>
  <p><b>Level:</b>  ${client_levels_data.find((e) => e.UniqueID == entity.layer && e.Level == layer)?.Level}</p><p></p>`;

                  })


                tooltip2.append("img")
                  .attr("src", "./images/projecs.png")

                tooltip2
                  .style("left", d.pageX + 10 + "px")
                  .style("top", d.pageY - 28 + "px");
              })
              .on("mouseout", d => {
                tooltip2.style("opacity", 0);
              });
            break;

          default:
            console.log("Unsupported entity type:", entity.type);
        }
      });
    }

    function getBounds(entities) {
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

      entities.forEach(entity => {
        if (entity.vertices) {
          entity.vertices.forEach(vertex => {
            minX = Math.min(minX, vertex.x);
            minY = Math.min(minY, vertex.y);
            maxX = Math.max(maxX, vertex.x);
            maxY = Math.max(maxY, vertex.y);
          });
        } else if (entity.center) {
          minX = Math.min(minX, entity.center.x - entity.radius);
          minY = Math.min(minY, entity.center.y - entity.radius);
          maxX = Math.max(maxX, entity.center.x + entity.radius);
          maxY = Math.max(maxY, entity.center.y + entity.radius);
        }
      });

      return { minX, minY, maxX, maxY };
    }

    function dragStarted(event, d) {
      d3.select(this)
        .raise()
        .style("cursor", "grabbing");
    }

    function dragged(event, d) {
  const layerId = +d3.select(this).attr("id").split("-")[2];
  layerTransforms[layerId].x += event.dx;
  layerTransforms[layerId].y += event.dy;
  updateTransform(layerId);
}


const transformations = {}; 
let fileHandle = null;

async function dragEnded(event, d) {
  d3.select(this)
    .style("cursor", "grab");

  const transform = d3.select(this).attr("transform");
  const layer = this.id.split('-').pop();

  transformations[layer] = {
    transform: transform
  };

  console.log(`Layer ${layer} moved to:`, event.x, event.y);
  console.log(`Saved Transform:`, transform);

  await saveTransformations(); 
}

async function getFileHandle() {
  if (!fileHandle) {
      try {
      [fileHandle] = await window.showOpenFilePicker({
        types: [{
          description: 'JSON Files',
          accept: { 'application/json': ['.json'] }
        }]
      });
    } catch (err) {
      if (err.name === 'AbortError') {
        console.warn('File selection aborted by user.');
      } else {
        console.error('Error selecting file:', err);
      }
    }
  }
}

async function saveTransformations() {
   try {
     if (!fileHandle) await getFileHandle();
     if (!fileHandle) return;
 
     let existingData = {};
     try {
       const file = await fileHandle.getFile();
       const text = await file.text();
       existingData = JSON.parse(text);
     } catch (e) {
       console.log('No existing file or error reading file:', e);
     }
 
     Object.assign(existingData, transformations);
 
     const writable = await fileHandle.createWritable();
     await writable.write(JSON.stringify(existingData, null, 2));
     await writable.close();
 
     console.log('Transformations saved successfully!');
   } catch (err) {
     if (err.name === 'AbortError') {
       console.warn('File save aborted by user.');
     } else {
       console.error('Error saving file:', err);
     }
   }
 }

    const layer1 = await d3.json(`./files/layer-1.json`);
    readDXF(layer1, 1);

    const layer2 = await d3.json(`./files/layer-2.json`);
    readDXF(layer2, 2);

    const layer3 = await d3.json(`./files/layer-3.json`);
    readDXF(layer3, 3);

    // document.getElementById("fileInput1").addEventListener("change", e => loadDXF(e.target.files[0], 1));
    // document.getElementById("fileInput2").addEventListener("change", e => loadDXF(e.target.files[0], 2));
    // document.getElementById("fileInput3").addEventListener("change", e => loadDXF(e.target.files[0], 3));

    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener("change", renderLayers);
    });


    async function readDXF(data, layer) {
      try {
        layers[layer] = data;
        console.log(`Loaded DXF for Layer ${layer}`, data);
        renderLayers();
      } catch (error) {
        console.error(`Error parsing DXF for Layer ${layer}:`, error);
      }
    }
  </script>
</body>

</html>